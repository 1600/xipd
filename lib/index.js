// Generated by CoffeeScript 1.3.2
(function() {
  var NS_C_IN, NS_RCODE_NXDOMAIN, NS_T_A, NS_T_CNAME, NS_T_NS, NS_T_SOA, PATTERN, createSOA, decode, dnsserver, encode, matchIP;

  dnsserver = require("dnsserver");

  NS_T_A = 1;

  NS_T_NS = 2;

  NS_T_CNAME = 5;

  NS_T_SOA = 6;

  NS_C_IN = 1;

  NS_RCODE_NXDOMAIN = 3;

  PATTERN = /^[a-z0-9]{1,7}$/;

  exports.encode = encode = function(ip) {
    var byte, index, value, _i, _len, _ref;
    value = 0;
    _ref = ip.split(".");
    for (index = _i = 0, _len = _ref.length; _i < _len; index = ++_i) {
      byte = _ref[index];
      value += parseInt(byte, 10) << (index * 8);
    }
    return (value >>> 0).toString(36);
  };

  exports.decode = decode = function(string) {
    var i, ip, value, _i;
    if (!PATTERN.test(string)) {
      return;
    }
    value = parseInt(string, 36);
    ip = [];
    for (i = _i = 1; _i <= 4; i = ++_i) {
      ip.push(value & 0xFF);
      value >>= 8;
    }
    return ip.join(".");
  };

  createSOA = function(domain) {
    var expire, minimum, mname, refresh, retry, rname, serial;
    mname = "ns-1." + domain;
    rname = "hostmaster." + domain;
    serial = parseInt(new Date().getTime() / 1000);
    refresh = 28800;
    retry = 7200;
    expire = 604800;
    minimum = 3600;
    return dnsserver.createSOA(mname, rname, serial, refresh, retry, expire, minimum);
  };

  matchIP = function(parts) {
    var matched, part, _i, _len, _ref;
    if (parts.length < 4) {
      return;
    }
    matched = true;
    _ref = parts.slice(0, 4);
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      part = _ref[_i];
      part = parseInt(part, 10);
      if (!((0 <= part && part <= 255))) {
        matched = false;
      }
    }
    return matched;
  };

  exports.createServer = function(domain, address) {
    var encodeCname, parseHostname, server, soa;
    if (address == null) {
      address = "127.0.0.1";
    }
    server = new dnsserver.Server;
    domain = ("" + domain).toLowerCase();
    soa = createSOA(domain);
    parseHostname = function(hostname) {
      var offset, subdomain;
      if (!hostname) {
        return;
      }
      hostname = hostname.toLowerCase();
      offset = hostname.length - domain.length;
      if (domain === hostname.slice(offset)) {
        if (0 < offset) {
          subdomain = hostname.slice(0, offset - 1);
          return subdomain.split('.').reverse();
        } else {
          return [];
        }
      }
    };
    encodeCname = function(subdomain) {
      var hostname, name, rest;
      if (matchIP(subdomain)) {
        name = encode(subdomain.slice(0, 4).reverse().join("."));
        if (subdomain.length > 4) {
          rest = subdomain.slice(4).reverse().join(".") + ".";
        } else {
          rest = "";
        }
        hostname = "" + rest + name + "." + domain;
        return dnsserver.createName(hostname);
      }
    };
    server.on("request", function(req, res) {
      var cname, q, subdomain, _ref, _ref1;
      q = (_ref = req.question) != null ? _ref : {};
      subdomain = parseHostname(q.name);
      if (q.type === NS_T_A && q["class"] === NS_C_IN && (subdomain != null)) {
        if (cname = encodeCname(subdomain)) {
          res.addRR(q.name, NS_T_CNAME, NS_C_IN, 600, cname);
        } else {
          res.addRR(q.name, NS_T_A, NS_C_IN, 600, (_ref1 = decode(subdomain[0])) != null ? _ref1 : address);
        }
      } else if (q.type === NS_T_NS && q["class"] === NS_C_IN && (subdomain != null ? subdomain.length : void 0) === 0) {
        res.addRR(q.name, NS_T_SOA, NS_C_IN, 600, soa, true);
      } else {
        res.header.rcode = NS_RCODE_NXDOMAIN;
      }
      return res.send();
    });
    return server;
  };

}).call(this);
